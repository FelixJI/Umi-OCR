# 代码质量检查工具使用说明

## 概述

本目录包含两个Python代码质量检查工具：

1. **check_syntax.py** - 语法检查工具
2. **check_types.py** - 类型注解检查工具

这些工具可以帮助开发者在提交代码前进行自我检查，提高代码质量。

## 前置要求

### 必需的工具

确保已在Python虚拟环境中安装以下工具：

```bash
# 安装代码检查工具
pip install ruff mypy black types-Pillow
```

或者使用项目的开发依赖：

```bash
pip install -e ".[dev]"
```

### 工具说明

- **ruff**: 快速的Python linter，用于语法检查
- **mypy**: 静态类型检查工具，用于类型注解检查
- **black**: Python代码格式化工具
- **types-Pillow**: Pillow的类型存根文件

## 使用方法

### 1. 语法检查

检查项目中所有Python文件的语法错误：

```bash
python check_syntax.py
```

**检查内容**：
- E类错误：pycodestyle代码风格错误
- F类错误：PyFlakes语法错误

**排除目录**：
- `paddle_doc` - Paddle文档目录
- `__pycache__` - Python缓存目录
- `.git` - Git版本控制目录
- `.mypy_cache` - MyPy缓存目录
- `.pytest_cache` - PyTest缓存目录
- `.venv`, `venv` - 虚拟环境目录
- `build`, `dist` - 构建和分发目录
- `*.egg-info` - 包信息目录
- `test_` 开头的文件 - 测试文件

**输出示例**：

```
======================================================================
语法检查工具
======================================================================
项目根目录: C:\Users\felji\PycharmProjects\Umi-OCR
排除目录: ['paddle_doc', '__pycache__', '.git', ...]

找到 142 个Python文件

使用ruff检查 142 个文件的语法...

[OK] 所有文件语法检查通过

======================================================================
[OK] 语法检查完成，所有文件通过
======================================================================
```

### 2. 类型注解检查

检查项目中所有Python文件的类型注解：

```bash
python check_types.py
```

**检查内容**：
- 类型错误（error级别）
- 类型警告（warning级别）
- 缺失的类型注解（静态分析）

**mypy配置**：
- `--ignore-missing-imports`: 忽略缺失的导入（第三方库）
- `--allow-untyped-defs`: 允许未注解的函数定义
- `--warn-return-any`: 警告返回Any类型
- `--warn-unused-ignores`: 警告未使用的类型忽略注释

**输出示例**：

```
======================================================================
类型注解检查工具
======================================================================
项目根目录: C:\Users\felji\PycharmProjects\Umi-OCR
排除目录: ['paddle_doc', '__pycache__', '.git', ...]

找到 142 个Python文件

使用mypy检查 142 个文件的类型注解...

无法解析mypy输出: src\utils\logger.py: error: Source file found twice under different module names...
[OK] 类型检查通过（0 个警告）

分析缺失的类型注解...
注意：这是静态分析，可能存在误报，仅供参考。

分析完成，共发现 1379 处缺失类型注解：
  - 函数: 159 个
  - 方法: 257 个
  - 变量: 963 个

检查结果已保存到: C:\Users\felji\PycharmProjects\Umi-OCR\type_check_results.json

======================================================================
[OK] 类型注解检查完成
======================================================================
```

### 3. 代码格式化

使用black格式化代码（自动修复大部分风格问题）：

```bash
# 格式化所有代码
black --line-length=88 src/ scripts/ main.py release.py build_nuitka.py

# 或使用ruff格式化
ruff format src/ scripts/ main.py release.py build_nuitka.py
```

## 输出文件

运行 `check_types.py` 后会生成 `type_check_results.json` 文件，包含：

```json
{
  "type_check": {
    "errors": [],          // 类型错误列表
    "warnings": [],        // 类型警告列表
    "stdout": "...",        // mypy原始输出
    "stderr": "..."         // mypy错误输出
  },
  "missing_annotations": {
    "functions": [...],     // 缺失类型注解的函数
    "methods": [...],       // 缺失类型注解的方法
    "variables": [...]      // 缺失类型注解的变量
  }
}
```

## 常见错误类型

### F821 - 未定义的名称

**严重错误**，会导致代码无法运行。

```python
# 错误示例
result = undefined_function()  # F821: undefined name 'undefined_function'

# 修复方法
# 1. 添加缺失的导入
from some_module import undefined_function

# 2. 定义该函数
def undefined_function():
    pass
```

### E722 - 裸except

**代码风格问题**，应该指定异常类型。

```python
# 不推荐
try:
    do_something()
except:  # E722: do not use bare 'except'
    pass

# 推荐
try:
    do_something()
except Exception as e:
    pass
```

### E501 - 行太长

**代码风格问题**，建议保持行长度不超过88字符。

```python
# 不推荐（太长）
result = very_long_function_name(param1, param2, param3, param4, param5, param6, param7, param8, param9)  # E501

# 推荐
result = very_long_function_name(
    param1, param2, param3, param4,
    param5, param6, param7, param8, param9
)
```

### F841 - 未使用的局部变量

**代码风格问题**，变量定义后未使用。

```python
# 警告
def example():
    unused_var = 123  # F841: local variable 'unused_var' is assigned to but never used
    return 456

# 修复：使用该变量或删除它
def example():
    var = 123
    return var + 456
```

### E402 - 模块级导入不在文件顶部

**代码风格问题**，所有导入应该在文件顶部。

```python
# 不推荐
import os

def some_function():
    import sys  # E402: module level import not at top of file
    pass

# 推荐
import os
import sys

def some_function():
    pass
```

## 最佳实践

### 1. 开发流程

建议在以下情况下运行检查：

- 提交代码前（必须）
- 创建Pull Request前（必须）
- 重要功能开发完成后（推荐）
- 定期代码审查时（推荐）

### 2. CI/CD集成

可以将这些检查集成到CI/CD流程中：

```yaml
# .github/workflows/code-quality.yml 示例
name: Code Quality

on: [push, pull_request]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          pip install ruff mypy black
      - name: Run syntax check
        run: python check_syntax.py
      - name: Run type check
        run: python check_types.py
```

### 3. Pre-commit Hook

配置pre-commit hook自动运行检查：

```yaml
# .pre-commit-config.yaml
repos:
  - repo: local
    hooks:
      - id: syntax-check
        name: Syntax Check
        entry: python check_syntax.py
        language: system
        pass_filenames: false
      - id: type-check
        name: Type Check
        entry: python check_types.py
        language: system
        pass_filenames: false
      - id: format-code
        name: Format Code
        entry: black --line-length=88
        language: system
        types: [python]
```

### 4. 类型注解建议

虽然当前项目有大量缺失的类型注解，但建议：

1. **优先为公共API添加类型注解**
   - 对外暴露的函数
   - 类的公共方法
   - 数据模型的属性

2. **逐步完善核心逻辑的类型注解**
   - 业务逻辑函数
   - 数据处理函数
   - 工具函数

3. **测试代码和示例代码可以适当简化**
   - 测试代码通常不需要完整的类型注解
   - 示例代码可以适当放宽要求

## 故障排除

### 问题1: ruff命令未找到

**错误信息**：`'ruff' is not recognized`

**解决方案**：
```bash
# 确保在虚拟环境中
.venv/Scripts/activate  # Windows
source .venv/bin/activate  # Linux/Mac

# 重新安装
pip install ruff
```

### 问题2: mypy检查很慢

**原因**：mypy需要分析所有导入

**解决方案**：
- 只检查修改的文件：`mypy src/modified_file.py`
- 使用缓存：`mypy --cache-dir .mypy_cache`
- 忽略某些导入：`--ignore-missing-imports`

### 问题3: 类型检查失败但代码可以运行

**原因**：类型注解不完整或第三方库类型存根缺失

**解决方案**：
- 添加类型忽略注释：`# type: ignore`
- 安装类型存根：`pip install types-<package>`
- 配置mypy忽略某些检查

## 更新日志

### 2026-01-28
- 创建 `check_syntax.py` - 语法检查工具
- 创建 `check_types.py` - 类型注解检查工具
- 添加详细的中文注释和使用说明
- 修复所有F821未定义名称错误
- 使用black格式化代码

## 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues: https://github.com/hiroi-sora/Umi-OCR/issues
