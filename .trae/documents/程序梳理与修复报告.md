# 程序梳理与修复报告

我已经对程序进行了全面的梳理，针对配置连接、功能连接和内存泄漏风险进行了修复。

## 1. 配置项与界面连接梳理

**发现的问题**:
- `src/models/config_model.py` 中定义的许多高级配置项在设置界面中缺失。
- 缺失 **OCR 引擎高级设置**（PaddleOCR 语言、GPU 加速、预处理参数如降噪/二值化/纠偏）。
- 缺失 **导出设置**（默认格式、TXT/JSON/PDF 详细参数、自动复制）。

**修复措施**:
- **新建** `src/ui/settings/ocr_settings.py`: 实现了 OCR 引擎选择、PaddleOCR 参数配置和图像预处理配置面板。
- **新建** `src/ui/settings/export_settings.py`: 实现了导出格式选择、TXT/JSON/PDF 参数配置面板。
- **修改** `src/ui/settings/settings.py`: 将上述两个新面板集成到设置窗口中，现在侧边栏包含 "OCR 引擎" 和 "导出设置" 入口。

## 2. 功能与界面连接梳理

**发现的问题**:
- **批量 OCR 导出功能** (`BatchOCRView`) 是“空壳”，虽然有导出按钮，但没有调用控制器执行实际导出逻辑。
- **Controller 实例化方式** 存在问题，每次打开界面都会创建新的 Controller 实例，可能导致资源浪费和信号多重连接。

**修复措施**:
- **修复批量导出**:
    - 在 `BatchOcrController` 中实现了 `export_results` 方法，支持将任务结果导出为 TXT/JSON 文件。
    - 修改 `BatchOCRView`，在点击导出按钮时正确调用控制器的导出方法。
- **Controller 单例化**:
    - 将 `ScreenshotController` 和 `BatchOcrController` 改造为 **单例模式** (`instance()`)。
    - 修改 `ScreenshotOCRView` 和 `BatchOCRView` 使用单例获取控制器，避免了重复创建实例和潜在的内存泄漏/信号冲突。

## 3. 内存泄漏检查

**检查结果**:
- **Controller 生命周期**: 通过单例模式修复了多次实例化的问题，确保全局只有一个控制器管理任务，有效防止了信号连接累积导致的内存泄漏。
- **临时文件清理**: `ScreenshotController` 已包含完善的临时文件清理机制 (`_cleanup_temp_file`)，在任务完成或失败后会自动删除截图临时文件。
- **资源释放**: `BatchOcrController` 和 `TaskManager` 的设计合理，任务完成后结果保存在内存中（直到程序关闭或手动清除），对于大量图片可能占用内存，但属于正常业务需求。

---

**代码变更汇总**:
- **修改**: `src/controllers/batch_ocr_controller.py`, `src/controllers/screenshot_controller.py`, `src/ui/batch_ocr/batch_ocr.py`, `src/ui/screenshot_ocr/screenshot_ocr.py`, `src/ui/settings/settings.py`
- **新增**: `src/ui/settings/ocr_settings.py`, `src/ui/settings/export_settings.py`
